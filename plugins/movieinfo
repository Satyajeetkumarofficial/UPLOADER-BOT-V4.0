import sys
import requests
from pyrogram import Client, filters
from pyrogram.types import Message
from pyrogram.enums import ParseMode
from plugins.config import Config

TMDB_API_KEY = Config.TMDB_API_KEY
OWNER_ID = int(Config.OWNER_ID)  # ensure integer
BASE_URL = "https://api.themoviedb.org/3"

print("✅ movieinfo plugin imported", file=sys.stderr)  # plugin load confirm


# ✅ Poster fetch helper
def get_poster_url(movie_id: int):
    try:
        print(f"🔎 Fetching poster for movie_id={movie_id}", file=sys.stderr)
        url = f"{BASE_URL}/movie/{movie_id}/images?api_key={TMDB_API_KEY}&include_image_language=hi,en,null"
        resp = requests.get(url, timeout=10).json()
        backdrops = resp.get("backdrops", [])
        posters = resp.get("posters", [])

        # Hindi backdrop first
        for b in backdrops:
            if b.get("iso_639_1") == "hi":
                return f"https://image.tmdb.org/t/p/original{b['file_path']}"

        # English backdrop
        for b in backdrops:
            if b.get("iso_639_1") == "en":
                return f"https://image.tmdb.org/t/p/original{b['file_path']}"

        # Any poster
        if posters:
            return f"https://image.tmdb.org/t/p/original{posters[0]['file_path']}"

        # Any scene as fallback
        if backdrops:
            return f"https://image.tmdb.org/t/p/original{backdrops[0]['file_path']}"

        return None
    except Exception as e:
        print(f"❌ get_poster_url error: {e}", file=sys.stderr)
        return None


# ✅ Test command: /ping (OWNER only)
@Client.on_message(filters.command("ping") & filters.user(OWNER_ID))
async def ping_command(client: Client, message: Message):
    print("✅ /ping command received", file=sys.stderr)
    await message.reply_text("pong ✅")
    print("✅ /ping command replied", file=sys.stderr)


# ✅ Movie Info command (OWNER only)
@Client.on_message(filters.command("movieinfo") & filters.user(OWNER_ID))
async def movieinfo_command(client: Client, message: Message):
    print("✅ /movieinfo command triggered", file=sys.stderr)

    if len(message.command) < 2:
        await message.reply_text("❌ Usage: /movieinfo <movie name> [year]")
        print("⚠️ Not enough arguments", file=sys.stderr)
        return

    # Movie name + optional year
    if message.command[-1].isdigit() and len(message.command[-1]) == 4:
        year = message.command[-1]
        name = " ".join(message.command[1:-1])
    else:
        year = None
        name = " ".join(message.command[1:])

    print(f"🔎 Searching movieinfo for: {name} ({year})", file=sys.stderr)

    # 🔎 Search movie on TMDb
    search_url = f"{BASE_URL}/search/movie?api_key={TMDB_API_KEY}&query={name}"
    if year:
        search_url += f"&year={year}"

    try:
        resp = requests.get(search_url, timeout=10).json()
        results = resp.get("results", [])
    except Exception as e:
        await message.reply_text(f"❌ API error: {e}")
        print(f"❌ API error: {e}", file=sys.stderr)
        return

    if not results:
        await message.reply_text(f"❌ No results found for {name} ({year or ''})")
        print("⚠️ No results found", file=sys.stderr)
        return

    movie = results[0]
    movie_id = movie["id"]

    print(f"✅ Found movie: {movie.get('title')} ({movie_id})", file=sys.stderr)

    # 🔹 Movie details
    details_url = f"{BASE_URL}/movie/{movie_id}?api_key={TMDB_API_KEY}&language=en-US"
    details = requests.get(details_url, timeout=10).json()

    # 🔹 Credits (actors + director)
    credits_url = f"{BASE_URL}/movie/{movie_id}/credits?api_key={TMDB_API_KEY}&language=en-US"
    credits = requests.get(credits_url, timeout=10).json()

    cast = credits.get("cast", [])
    crew = credits.get("crew", [])

    # Top 5 actors
    top_actors = ", ".join([actor["name"] for actor in cast[:5]]) or "N/A"

    # Director(s)
    directors = [member["name"] for member in crew if member.get("job") == "Director"]
    director_names = ", ".join(directors) if directors else "N/A"

    title = details.get("title")
    release_date = details.get("release_date", "N/A")
    year = release_date.split("-")[0] if release_date else "N/A"
    overview = details.get("overview", "No description available.")
    genres = ", ".join([g["name"] for g in details.get("genres", [])]) or "N/A"
    language = details.get("original_language", "N/A").upper()
    runtime = details.get("runtime", "N/A")

    poster_url = get_poster_url(movie_id)

    caption = (
        f"🎬 <b>{title}</b> ({year})\n\n"
        f"🗓 Release Date: {release_date}\n"
        f"⏱ Runtime: {runtime} min\n"
        f"🌐 Language: {language}\n"
        f"🎭 Genres: {genres}\n"
        f"🎬 Director: {director_names}\n"
        f"⭐ Cast: {top_actors}\n\n"
        f"📝 {overview}\n\n"
        f"Generated By : @UrlProUploaderBot"
    )

    try:
        if poster_url:
            await message.reply_photo(poster_url, caption=caption, parse_mode=ParseMode.HTML)
        else:
            await message.reply_text(caption, parse_mode=ParseMode.HTML)

        print(f"✅ Movieinfo sent for {title} ({year})", file=sys.stderr)
    except Exception as e:
        print(f"❌ Failed to send movieinfo: {e}", file=sys.stderr)
        await message.reply_text(f"❌ Error: {e}")
