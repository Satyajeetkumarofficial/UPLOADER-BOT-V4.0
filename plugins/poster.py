from pyrogram import Client, filters
from pyrogram.types import Message
import requests
from io import BytesIO
from plugins.config import Config


@Client.on_message(filters.command("posterinfo") & filters.user(Config.OWNER_ID))
async def poster_info_command(bot: Client, message: Message):
    if len(message.command) < 2:
        await message.reply_text("❌ Usage: /posterinfo <movie name> [year]")
        return

    # Movie name + optional year
    if message.command[-1].isdigit() and len(message.command[-1]) == 4:
        movie_year = message.command[-1]
        movie_name = " ".join(message.command[1:-1])
    else:
        movie_year = None
        movie_name = " ".join(message.command[1:])

    # TMDb Search API
    search_url = f"https://api.themoviedb.org/3/search/movie?api_key={Config.TMDB_API_KEY}&query={movie_name}"
    if movie_year:
        search_url += f"&year={movie_year}"

    resp = requests.get(search_url, timeout=10).json()
    if not resp.get("results"):
        await message.reply_text(f"❌ Movie '{movie_name}' not found.")
        return

    movie = resp["results"][0]
    title = movie.get("title", movie_name)
    release_date = movie.get("release_date", "")
    year = release_date.split("-")[0] if release_date else movie_year
    movie_id = movie["id"]

    # TMDb movie images API
    images_url = f"https://api.themoviedb.org/3/movie/{movie_id}/images?api_key={Config.TMDB_API_KEY}"
    images_resp = requests.get(images_url, timeout=10).json()

    posters = images_resp.get("posters", [])

    # Filter: landscape vs portrait
    landscape = [p for p in posters if p.get("width", 0) >= 1200 and p.get("width", 0) > p.get("height", 0)][:10]
    portrait = [p for p in posters if p.get("height", 0) > p.get("width", 0)][:10]

    # First landscape upload
    photo_bytes = None
    if landscape:
        first_landscape_url = f"https://image.tmdb.org/t/p/original{landscape[0]['file_path']}"
        img = requests.get(first_landscape_url, timeout=10)
        if img.status_code == 200:
            photo_bytes = BytesIO(img.content)
            photo_bytes.name = "poster.jpg"
            photo_bytes.seek(0)

    # Links
    landscape_links = [f"https://image.tmdb.org/t/p/original{p['file_path']}" for p in landscape]
    portrait_links = [f"https://image.tmdb.org/t/p/w500{p['file_path']}" for p in portrait]

    caption_text = f"🎬 Movie: {title} ({year})\n\n"
    if landscape_links:
        caption_text += "• English Landscape:\n"
        for i, link in enumerate(landscape_links, 1):
            caption_text += f"{i}. {link}\n"
    if portrait_links:
        caption_text += "\n• Portrait Posters:\n"
        for i, link in enumerate(portrait_links, 1):
            caption_text += f"{i}. {link}\n"

    caption_text += "\nGenerated By : @UrlProUploaderBot"

    # Send photo + caption
    if photo_bytes:
        await message.reply_photo(photo=photo_bytes, caption=caption_text)
    else:
        await message.reply_text(caption_text)
